<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8" />
<title>글 리스트</title>
<script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
<script src="../../../static/js/jquery.form.js" th:src="@{/js/jquery.form.js}"></script>
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" />
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css" />
<script type="text/javascript">
function initWriteForm(){
	$('#writeForm').val('');
	$('#password').val('');
}

function writePost(email){
	
	var content = $('#writeForm').val();
	var password = $('#password').val();
	
	if('' === content || undefined === content){
		alert("글을 작성해 주세요.");
		return;
	}
	
	if('' === password || undefined === password){
		alert("비밀번호를 설정해 주세요.");
		return;
	}
	
	$.ajax({      
        type:"POST",  
        url:"/write",      
        data:{
        	email : email,
        	content : content,
        	password : password
        },      
        success:function(data){   
        	alert('글쓰기 ' + data);
            if(data === '성공'){
            	$('#myModal').modal('hide');
            	location.href = '/list';
            }
        },   
        error:function(e){ 
        	// e.responseText
            alert('글 게시 중 오류가 발생했습니다.');  
        }  
    });
}

function deletePost(currentUser, uploader, postId){
	
	if(currentUser !== uploader){
		alert('자신의 게시물만 삭제할 수 있습니다.');
		return;
	}
	
	$.ajax({      
        type:"GET",  
        url:"/delete",      
        data : {
        	postId : postId
        },
        success:function(data){   
        	alert('게시글 삭제에 ' + data);
            location.href = '/list';
        },   
        error:function(e){ 
            alert('삭제중 중 오류가 발생했습니다.');  
        }  
    });
}

function logout(){
	$.ajax({      
        type:"POST",  
        url:"/logout",      
        success:function(data){   
        	alert('로그아웃에 ' + data);
            location.href = '/form/login';
        },   
        error:function(e){ 
            alert('로그아웃 중 오류가 발생했습니다.');  
        }  
    });
}

$(window).scroll(function() {
    if ($(window).scrollTop() == $(document).height() - $(window).height()) {
        $('#footer').fadeOut('fast');
    }else{
    	$('#footer').fadeIn('fast');
    }
});

function openModal(){
	var args = arguments;
	// 전송 역할을 하는 모달내의 버튼 클릭시 발생할 콜백 함수. 
	var callback = function(){
		if(args[0] === 'post'){
			writePost(args[1]);
		}else if(args[0] === 'reply'){
			reply(args[1], args[2], $('#writeForm').val(), $('#password').val());
		}
		
		// 모든 작업이 종료되면 모달창 숨기기.
		$('#postModal').modal('hide');
	};
	
	// 입력 폼 초기화 후 보여주기.
	initWriteForm();
	$('#postModal').modal('show');
	
	// 클릭시 수행될 콜백함수 지정.
	$('#postModal #sendButton').click(callback);
	
	// 모달이 화면에서 사라졌을 때 이벤트 지정. 버튼에 지정해둔 모든 콜백함수를 제거한다.
	$('#postModal').on('hidden.bs.modal', function (e) {
		$('#postModal #sendButton').unbind();
	});
}

function reply(postId, userId, content, password){
	$.ajax({      
        type : "POST",  
        url : "/reply",      
        data : {
        	postId : postId,
        	userId : userId,
        	content : content,
        	password : password
        },
        success : function(data){   
        	alert('답글 게시에 ' + data);
            location.href = '/list';
        },   
        error : function(e){ 
            alert('답글 게시 중 오류가 발생했습니다.');  
        }  
    });
}
</script>
</head>
<body>
	<nav class="navbar navbar-default">
		<div class="container-fluid">
			<div class="navbar-header">
				<a class="navbar-brand" href="#"> Pilot Project </a>
			</div>
			<ul class="nav navbar-nav navbar-right">
				<!-- 다음과 같이 session을 통하여 세션객체에 접근할 수 있다 -->
				<li><a th:text="'환영합니다 ' + ${session.userInfo.name} + '님'"></a></li>
				<!-- onclick()에서 false를 반환받게 되면 앵커태그는 주소를 이동하지 않는다. -->
				<li><a href="#" th:onclick="'openModal(\'post\', \''+${session.userInfo.email}+'\'); return false;'"> 글쓰기 </a></li>
				<li><a href="#" onclick="logout(); return false;"> 로그아웃 </a></li>
			</ul>
		</div>
	</nav><!-- 네비게이션 헤더 -->

	<table>
		<tr th:each="post: ${posts}">
			<td class="col-md-1">
				<div class="panel panel-default">
					<div class="panel-heading">
						<div>
							<div>
								<span class="badge" th:text="${post.uploader}">작성자</span>
								<span class="badge" th:text="'댓글 ' + ${post.replySize} + '개'">댓글 갯수</span>
								<span class="badge" th:text="${#dates.format(post.post.regdate, 'yyyy년 MM월 dd일 hh시 mm분 ss초')}">작성일</span>
								<a th:onclick="'openModal(\'reply\', \''+${post.post.id}+'\', \''+${session.userInfo.id}+'\');'">답글</a>
								<a th:onclick="'deletePost(\''+${session.userInfo.id}+'\', \''+${post.post.user}+'\', \''+${post.post.id}+'\');'">삭제</a>
							</div>
						</div>
					</div>
					<div>
						<img src="../static/images/kth.PNG" th:src="@{/images/kth.PNG}"/> 
					</div>
					<div class="panel-body" th:text="${post.post.content}">게시글 내용</div>
					<div class="panel-footer" th:each="reply: ${post.post.replies}">
						<p th:text="${#dates.format(reply.regdate, 'yyyy년 MM월 dd일 hh시 mm분 ss초')}">답글 게시일</p>
						<p th:text="${reply.content}">답글 내용</p>
					</div>
				</div>
			</td>
		</tr>
	</table>

	<nav class="navbar navbar-default navbar-fixed-bottom" id="footer">
	  <div class="container" style="text-align: center;">
	    <ul class="pagination">
	    	<!-- class="disabled" 시 마우스 클릭 불가 -->
		    <li class="disabled"><a href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a></li>
		    <li class="active"><a href="#">1 <span class="sr-only">(current)</span></a></li>
		    <li><a href="#">2 <span class="sr-only">(current)</span></a></li>
		    <li><a href="#">3 <span class="sr-only">(current)</span></a></li>
		    <li><a href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a></li>
	  	</ul>
	  </div>
	</nav><!-- 네비게이션 풋터 -->

	<!-- <div class="modal fade" th:include="inputModal :: [//div[@id='modal']]" id="myModal"></div> -->
	<div class="modal fade" id="postModal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title">입력창</h4>
				</div>
				<div class="modal-body">
					<div class="form-group">
					    <label for="writeForm">글 쓰기</label>
					    <input type="file" name="file" />
					    <textarea class="form-control" id="writeForm" placeholder="글을 입력하세요" rows="6"></textarea>
					    <input
							type="password" class="form-control" id="password" name="password"
							required="required" placeholder="비밀번호를 입력하세요." style="margin-right: 20px; margin-top: 15px;"/>
				  	</div>
				</div>
				<div class="modal-footer">
					<!-- th:onclick="'writePost(\''+${session.userInfo.email}+'\');'" -->
					<button type="button" class="btn btn-primary" id="sendButton">확인</button>
					<button type="button" class="btn btn-default" data-dismiss="modal">취소</button>
				</div>
			</div>
		</div>
	</div><!-- 글 입력 모달 -->
</body>
</html>